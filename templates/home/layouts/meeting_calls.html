{% extends "home/base/base.html" %}
{% load static %}

{% block extra_css %}
<style>
:root {
    --primary-color: #2874a7;
    --text-dark: #2d3436;
    --text-light: #636e72;
    --text-muted: #95a5a6;
    --card-shadow: 0 10px 20px rgba(0,0,0,0.05);
    --card-shadow-hover: 0 15px 30px rgba(0,0,0,0.12);
    --history-bg: #f8fafc;
    --history-border: #e9ecef;
}

/* Header */
.news-header {
    text-align: center;
    padding: 310px 20px 50px;
    background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)),
                url("{% static 'home/images/banner4.png' %}");
    background-size: cover;
    background-position: center;
    color: white;
    margin-bottom: 50px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}
.news-header h1 { font-size: 3rem; color: #fff; font-weight: 400; }

/* Section titles */
.section-title { text-align: center; margin-bottom: 40px; position: relative; padding-bottom: 15px; }
.section-title h2 { font-size: 2.2rem; font-weight: 600; color: var(--text-dark); margin-bottom: 10px; }
.section-title .subtitle { color: var(--text-light); font-size: 1rem; max-width: 600px; margin: 0 auto; }
.section-title:after {
    content: '';
    position: absolute;
    bottom: 0; left: 50%;
    transform: translateX(-50%);
    width: 80px; height: 3px;
    background: linear-gradient(90deg, var(--primary-color), #4a9eff);
    border-radius: 2px;
}

/* Gallery & History */
.gallery-section, .history-section { padding: 5px 20px 60px; max-width: 1100px; margin: 0 auto; }
.gallery-grid, .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 30px; }

/* Cards */
.gallery-card, .history-card { text-decoration: none; display: block; transition: all 0.3s ease; }
.image-wrapper { position: relative; aspect-ratio: 4 / 3; overflow: hidden; border-radius: 16px; background-color: #f8f9fa; box-shadow: var(--card-shadow); transition: all 0.4s ease; }
.image-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
.gallery-card:not(.disabled-link):hover .image-wrapper { transform: translateY(-8px); box-shadow: var(--card-shadow-hover); }
.gallery-card:not(.disabled-link):hover img { transform: scale(1.08); }

/* Meeting info */
.meeting-info { padding: 15px 5px; text-align: center; }
.meeting-title { display: block; color: var(--text-dark); font-size: 1.05rem; font-weight: 600; margin-bottom: 4px; }
.meeting-date { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; display: block; }
.live-countdown { color: #e67e22; font-weight: bold; }

/* History cards */
.history-info { padding: 12px 5px; text-align: center; }
.history-title { display: block; color: var(--text-dark); font-size: 0.95rem; font-weight: 500; margin-bottom: 4px; }
.history-date { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; display: block; }
.history-badge { display: inline-block; background-color: #e9ecef; color: var(--text-muted); font-size: 0.7rem; padding: 2px 10px; border-radius: 20px; margin-top: 5px; }

.empty-history { grid-column: 1/-1; text-align: center; padding: 60px 20px; background: var(--history-bg); border-radius: 20px; }
.empty-history svg { width: 60px; height: 60px; color: #cbd5e0; margin-bottom: 15px; }

/* Toggle button */
.button-container { display: flex; justify-content: flex-end; margin-bottom: 20px; max-width: 1100px; margin-left: auto; margin-right: auto; padding: 0 20px; }
.toggle-history-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 30px; background: white; border: 2px solid var(--history-border); border-radius: 40px; font-weight: 600; cursor: pointer; }
.toggle-history-btn:hover { background: var(--history-bg); border-color: var(--primary-color); color: var(--primary-color); }
.upcoming-section.hidden, .history-section.hidden { display: none; }

/* Pagination */
.pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
.pagination a, .pagination span { padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 6px; text-decoration: none; color: #333; }
.pagination a:hover { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
.pagination span.current { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
.pagination span.disabled { opacity: 0.5; cursor: default; }

@media (max-width:600px) { .gallery-grid, .history-grid { grid-template-columns: 1fr; gap: 20px; } .news-header h1 { font-size:2rem; } .section-title h2 { font-size:1.8rem; } .button-container { justify-content:center; } .toggle-history-btn { width:100%; max-width:300px; } }
</style>
{% endblock extra_css %}

{% block main %}
<div class="news-header">
    <h1>Meeting Schedule</h1>
</div>

<div class="button-container">
    <button id="toggleHistoryBtn" class="toggle-history-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 8v8M8 12h8"/>
            <circle cx="12" cy="12" r="10"/>
        </svg>
        Show Previous Meetings
    </button>
</div>

<!-- Upcoming Meetings -->
<div id="upcomingSection" class="gallery-section upcoming-section">
    <div class="section-title">
        <h2>Upcoming Meetings</h2>
        <div class="subtitle">Join our upcoming sessions and stay connected</div>
    </div>
    <div class="gallery-grid">
        {% for meeting in upcoming_meetings %}
        <a href="{% url 'meeting_call' meeting.id %}" class="gallery-card">
            <div class="image-wrapper">
                {% if meeting.image %}
                    <img src="{{ meeting.image.url }}" alt="{{ meeting.title }}">
                {% else %}
                    <img src="{% static 'default_album.jpg' %}" alt="{{ meeting.title }}">
                {% endif %}
            </div>
            <div class="meeting-info">
                <span class="meeting-title">{{ meeting.title }}</span>
                <span class="meeting-date expiry-timer" data-expire="{{ meeting.expire_date|date:'Y-m-d H:i:s' }}">Calculating...</span>
            </div>
        </a>
        {% empty %}
        <div style="grid-column:1/-1; text-align:center; padding:40px;">
            <p class="text-muted">No upcoming meetings available.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Upcoming Pagination -->
    {% if upcoming_meetings.has_other_pages %}
    <div class="pagination">
        {% if upcoming_meetings.has_previous %}
            <a href="?upcoming_page=1">« First</a>
            <a href="?upcoming_page={{ upcoming_meetings.previous_page_number }}">← Prev</a>
        {% else %}
            <span class="disabled">« First</span>
            <span class="disabled">← Prev</span>
        {% endif %}

        {% for num in upcoming_meetings.paginator.page_range %}
            {% if upcoming_meetings.number == num %}
                <span class="current">{{ num }}</span>
            {% elif num > upcoming_meetings.number|add:'-3' and num < upcoming_meetings.number|add:'3' %}
                <a href="?upcoming_page={{ num }}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if upcoming_meetings.has_next %}
            <a href="?upcoming_page={{ upcoming_meetings.next_page_number }}">Next →</a>
            <a href="?upcoming_page={{ upcoming_meetings.paginator.num_pages }}">Last »</a>
        {% else %}
            <span class="disabled">Next →</span>
            <span class="disabled">Last »</span>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Previous Meetings -->
<div id="historySection" class="history-section hidden">
    <div class="section-title">
        <h2>Previous Meetings</h2>
        <div class="subtitle">Relive our past sessions and discussions</div>
    </div>
    <div class="history-grid">
        {% for meeting in previous_meetings %}
        <a class="history-card">
            <div class="image-wrapper">
                {% if meeting.image %}
                    <img src="{{ meeting.image.url }}" alt="{{ meeting.title }}">
                {% else %}
                    <img src="{% static 'default_album.jpg' %}" alt="{{ meeting.title }}">
                {% endif %}
            </div>
            <div class="history-info">
                <span class="history-title">{{ meeting.title }}</span>
                <span class="history-date">{{ meeting.expire_date|date:"M d, Y" }}</span>
                <span class="history-badge">Completed</span>
            </div>
        </a>
        {% empty %}
        <div class="empty-history">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            <p>No previous meetings found</p>
        </div>
        {% endfor %}
    </div>

    <!-- Previous Pagination -->
    {% if previous_meetings.has_other_pages %}
    <div class="pagination">
        {% if previous_meetings.has_previous %}
            <a href="?previous_page=1">« First</a>
            <a href="?previous_page={{ previous_meetings.previous_page_number }}">← Prev</a>
        {% else %}
            <span class="disabled">« First</span>
            <span class="disabled">← Prev</span>
        {% endif %}

        {% for num in previous_meetings.paginator.page_range %}
            {% if previous_meetings.number == num %}
                <span class="current">{{ num }}</span>
            {% elif num > previous_meetings.number|add:'-3' and num < previous_meetings.number|add:'3' %}
                <a href="?previous_page={{ num }}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if previous_meetings.has_next %}
            <a href="?previous_page={{ previous_meetings.next_page_number }}">Next →</a>
            <a href="?previous_page={{ previous_meetings.paginator.num_pages }}">Last »</a>
        {% else %}
            <span class="disabled">Next →</span>
            <span class="disabled">Last »</span>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock main %}

{% block extra_js %}
<script>
function updateTimers() {
    const timers = document.querySelectorAll('.expiry-timer');
    const now = new Date();
    timers.forEach(timer => {
        const expiry = new Date(timer.dataset.expire);
        const diff = expiry - now;
        const card = timer.closest('.gallery-card');
        if (diff <= 0) { card.style.display = 'none'; return; }
        const total = Math.floor(diff / 1000);
        const days = Math.floor(total / 86400);
        const hours = Math.floor((total % 86400) / 3600);
        const minutes = Math.floor((total % 3600) / 60);
        const seconds = total % 60;
        timer.innerHTML = days > 0 ? `${days}d ${hours}h ${minutes}m ${seconds}s left` :
                                      `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')} left`;
    });
}

const toggleBtn = document.getElementById('toggleHistoryBtn');
const upcoming = document.getElementById('upcomingSection');
const history = document.getElementById('historySection');
let showingPrev = false;
toggleBtn.addEventListener('click', () => {
    showingPrev = !showingPrev;
    upcoming.classList.toggle('hidden', showingPrev);
    history.classList.toggle('hidden', !showingPrev);
    toggleBtn.classList.toggle('active', showingPrev);
    toggleBtn.innerHTML = showingPrev ?
        `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v8M8 12h8"/><circle cx="12" cy="12" r="10"/></svg> Hide Previous Meetings` :
        `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v8M8 12h8"/><circle cx="12" cy="12" r="10"/></svg> Show Previous Meetings`;
});

setInterval(updateTimers, 1000);
updateTimers();
</script>
{% endblock extra_js %}