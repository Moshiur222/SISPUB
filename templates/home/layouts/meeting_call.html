{% extends "home/base/base.html" %}
{% block title %}Register{% endblock title %}

{% block main %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
/* Wrapper & Card */
.reg-wrapper {
    min-height: 90vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    background: linear-gradient(140deg, rgba(0, 72, 114, 0.9) 0%, rgba(41, 17, 96, 0.8) 100%);
    padding: 190px 20px 40px 20px; 
}

.reg-card {
    background: #ffffff;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 500px;
}

.reg-card h2 { 
    margin-bottom: 10px; 
    color: #333; 
    text-align: center; 
    font-weight: 700; 
}

.reg-card .description {
    text-align: center; 
    color: #777; 
    margin-bottom: 30px; 
    font-size: 0.95rem;
}

/* Form */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.form-group { margin-bottom: 18px; position: relative; }
.form-group label { display: block; margin-bottom: 6px; color: #555; font-size: 0.85rem; font-weight: 600; }

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    background-color: #fff;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #28a745;
    outline: none;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
}

.form-group select {
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg width='10' height='5' viewBox='0 0 10 5' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l5 5 5-5z' fill='%23333'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px 5px;
}

.reg-btn { 
    width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; 
    font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.3s; margin-top: 10px; 
}

.reg-btn:hover { background-color: #218838; }

.error-text { color: #dc3545; font-size: 0.8rem; margin-top: 4px; display: none; }
.success-text { color: #28a745; font-size: 0.8rem; margin-top: 4px; display: none; }
</style>

<div class="reg-wrapper">
    <div class="reg-card">
        <!-- Title and Description -->
        <h2>{{ title.title }}</h2>
        <div class="description">{{ title.description|safe }}</div>

        <form id="regForm" method="POST">
            {% csrf_token %}

            {% if messages %}
                {% for message in messages %}
                    <p style="text-align:center; color:{% if 'error' in message.tags %}#dc3545{% elif 'success' in message.tags %}#28a745{% else %}#333{% endif %}; font-weight:600;">
                        {{ message }}
                    </p>
                {% endfor %}
            {% endif %}

            <!-- Phone & Company Name -->
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" id="phoneInput" required placeholder="e.g. 01700000000 or +8801700000000" value="{{ phone }}">
                    <div id="phoneError" class="error-text"></div>
                    <div id="phoneSuccess" class="success-text">Phone No. valid</div>
                </div>
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" name="company_name" required value="{{ company_name }}">
                </div>
            </div>

            <!-- Person Name & No of Person -->
            <div class="form-row">
                <div class="form-group">
                    <label>Person Name</label>
                    <input type="text" name="name" required value="{{ name }}">
                </div>
                <div class="form-group">
                    <label>No of Person</label>
                    <input type="number" name="no_of_person" id="noOfPersonInput" required min="1" value="{{ no_of_person }}">
                </div>
            </div>

            <!-- Amount & Payment Method -->
            <div class="form-row">
                <div class="form-group">
                    <label>Amount</label>
                    <input type="text" name="amount" id="amountInput" readonly value="{{ amount }}">
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select name="payment_method" required>
                        <option value="bkash" {% if payment_method == "bkash" %}selected{% endif %}>Bkash</option>
                        <option value="nagad" {% if payment_method == "nagad" %}selected{% endif %}>Nagad</option>
                        <option value="rocket" {% if payment_method == "rocket" %}selected{% endif %}>Rocket</option>
                        <option value="bank_transfer" {% if payment_method == "bank_transfer" %}selected{% endif %}>Bank Transfer</option>
                    </select>
                </div>
            </div>

            <!-- Transection ID & Email -->
            <div class="form-row">
                <div class="form-group">
                    <label>Transection ID</label>
                    <input type="text" name="transection_id" required value="{{ transection_id }}">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" name="email" id="emailInput" required value="{{ email }}">
                    <div id="emailError" class="error-text"></div>
                    <div id="emailSuccess" class="success-text">Email available</div>
                </div>
            </div>

            <button type="submit" class="reg-btn">Submit</button>
        </form>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
// Email live check
const emailInput = document.getElementById('emailInput');
const emailError = document.getElementById('emailError');
const emailSuccess = document.getElementById('emailSuccess');
let emailExists = false;

if (emailInput) {
    emailInput.addEventListener('input', function() {
        const email = this.value.trim();
        if (email.length > 5) {
            emailError.innerText = "Checking...";
            emailError.style.display = 'block';
            emailSuccess.style.display = 'none';

            fetch('/check_email/?email=' + encodeURIComponent(email))
                .then(res => res.json())
                .then(data => {
                    if (data.exists) {
                        emailInput.style.borderColor = '#dc3545';
                        emailError.innerText = "Email already exists!";
                        emailError.style.display = 'block';
                        emailSuccess.style.display = 'none';
                        emailExists = true;
                    } else {
                        emailInput.style.borderColor = '#28a745';
                        emailError.style.display = 'none';
                        emailSuccess.style.display = 'block';
                        emailExists = false;
                    }
                }).catch(err => {
                    emailError.innerText = "Error checking email";
                    emailError.style.display = 'block';
                    emailExists = true;
                });
        } else {
            emailError.style.display = 'none';
            emailSuccess.style.display = 'none';
            emailExists = false;
        }
    });
}

// Phone validation
const phoneInput = document.getElementById('phoneInput');
const phoneError = document.getElementById('phoneError');
const phoneSuccess = document.getElementById('phoneSuccess');
let phoneValid = false;

if (phoneInput) {
    phoneInput.addEventListener('input', function() {
        const phone = this.value.trim();
        const regex = /^(?:\+8801[3-9][0-9]{8}|01[3-9][0-9]{8})$/;

        if (regex.test(phone)) {
            phoneInput.style.borderColor = '#28a745';
            phoneError.style.display = 'none';
            phoneSuccess.style.display = 'block';
            phoneValid = true;
        } else {
            phoneInput.style.borderColor = '#dc3545';
            phoneError.innerText = "Invalid BD phone number!";
            phoneError.style.display = 'block';
            phoneSuccess.style.display = 'none';
            phoneValid = false;
        }
    });
}

// Dynamic amount calculation
const noOfPersonInput = document.getElementById('noOfPersonInput');
const amountInput = document.getElementById('amountInput');
const perPersonAmount = {{ title.amount|default:0 }};

if (noOfPersonInput && amountInput) {
    noOfPersonInput.addEventListener('input', function() {
        const num = parseInt(this.value) || 0;
        amountInput.value = (num * perPersonAmount).toFixed(2);
    });
}

// Form submission validation
const form = document.getElementById('regForm');
form.addEventListener('submit', function(e) {
    if (emailExists) {
        e.preventDefault();
        emailError.innerText = "Email already exists!";
        emailError.style.display = 'block';
        emailInput.style.borderColor = '#dc3545';
    }

    if (phoneInput && !phoneValid) {
        e.preventDefault();
        phoneError.innerText = "Invalid BD phone number!";
        phoneError.style.display = 'block';
        phoneInput.style.borderColor = '#dc3545';
    }
});

phoneInput.addEventListener('blur', function() {
    const phone = this.value.trim();
    const regex = /^(?:\+8801[3-9][0-9]{8}|01[3-9][0-9]{8})$/;
    if (!regex.test(phone)) return;  // skip if invalid

    fetch(`/get_aggregator_info/?phone=${encodeURIComponent(phone)}`)
        .then(res => res.json())
        .then(data => {
            if (data.exists) {
                // Fill inputs with aggregator info
                if (data.data.company_name) document.querySelector('input[name="company_name"]').value = data.data.company_name;
                if (data.data.name) document.querySelector('input[name="name"]').value = data.data.name;
                if (data.data.no_of_person) document.querySelector('input[name="no_of_person"]').value = data.data.no_of_person;
                if (data.data.email) document.querySelector('input[name="email"]').value = data.data.email;
            }
        });
});

</script>
{% endblock main %}