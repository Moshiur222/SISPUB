{% extends "home/base/base.html" %}
{% load static %}
{% block title %}Register{% endblock title %}

{% block main %}
<style>
/* Registration page wrapper with background image */
.reg-wrapper {
    min-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;

    /* Background image */
    background: url("{% static 'home/images/banner4.png' %}") no-repeat center center;
    background-size: cover;
    position: relative;
}

/* Dark overlay for contrast */
.reg-wrapper::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 0;
}

/* Registration card */
.reg-card {
    background: #fff;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 500px;
    position: relative; /* Keep card above overlay */
    z-index: 1;
}

/* Card text */
.reg-card h2 {
    margin-bottom: 10px;
    color: #333;
    text-align: center;
    font-weight: 700;
}
.reg-card p {
    text-align: center;
    color: #777;
    margin-bottom: 30px;
    font-size: 0.9rem;
}

/* Form styles */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 6px; color: #555; font-size: 0.85rem; font-weight: 600; }
.form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; }
.form-group input:focus { border-color: #28a745; outline: none; }

.reg-btn { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.3s; margin-top: 10px; }
.reg-btn:hover { background-color: #218838; }

.footer-link { text-align: center; margin-top: 20px; font-size: 0.85rem; }
.error-text { color: #dc3545; font-size: 0.8rem; margin-top: 4px; display: none; }
.success-text { color: #28a745; font-size: 0.8rem; margin-top: 4px; display: none; }

.timer { text-align: center; margin-top: 10px; font-size: 0.85rem; color: #555; }
#resendBtn { padding: 5px 10px; margin-left: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; display: inline-block; }
#resendBtn:disabled { display: none; }
.change-number-btn { padding: 6px 12px; margin-top: 8px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; }
.change-number-btn:hover { background-color: #0056b3; }

/* Aggregator toggle switch */
.switch { position: relative; display: inline-block; width: 50px; height: 25px; margin-left: 10px; }
.switch input { display: none; }
.slider { position: absolute; cursor: pointer; background-color: #ccc; border-radius: 25px; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; }
input:checked + .slider { background-color: #28a745; }
input:checked + .slider:before { transform: translateX(25px); }

/* Responsive */
@media (max-width: 768px) {
    .reg-wrapper { padding: 20px; }
    .form-row { grid-template-columns: 1fr; }
}
</style>
<div class="reg-wrapper" style="margin-top: 100px">
    <div class="reg-card">
        <h2>{% if otp_sent %}Verify OTP{% else %}Create Account{% endif %}</h2>

        {% if otp_sent %}
            <p>
                Code sent to your phone 
                <strong id="phoneDisplay">{{phone}}</strong>
                <a class="change-phone" id="changePhoneBtn">Change</a>
            </p>
        {% else %}
            <p>Join us today! It only takes a minute.</p>
        {% endif %}

        <!-- Aggregator Toggle -->
        <div class="form-group">
            <label>Will you be an aggregator?</label>
            <label class="switch">
                <input type="checkbox" id="aggregatorToggle">
                <span class="slider round"></span>
            </label>
        </div>

        <form id="regForm" method="POST">
            {% csrf_token %}

            {% if messages %}
                {% for message in messages %}
                    <p style="text-align:center; 
                            color: {% if 'error' in message.tags %}#dc3545{% elif 'success' in message.tags %}#28a745{% else %}#333{% endif %}; 
                            font-weight: 600;">
                        {{ message }}
                    </p>
                {% endfor %}
            {% endif %}

            {% if not otp_sent %}
            <!-- Registration Fields -->
            <div class="form-group">
                <label>BRTC Licence No</label>
                <input type="text" name="brtc_licence_no" id="brtcLicenceInput" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" name="company_name" required>
                </div>
                <div class="form-group">
                    <label>Person Name</label>
                    <input type="text" name="name" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Designation</label>
                    <input type="text" name="designation" required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" name="address" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" id="phoneInput" required placeholder="e.g. 01700000000 or +8801700000000">
                    <div id="phoneError" class="error-text"></div>
                    <div id="phoneSuccess" class="success-text">Valid phone</div>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" name="email" id="emailInput" required>
                    <div id="emailError" class="error-text"></div>
                    <div id="emailSuccess" class="success-text">Email available</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="pass1" name="password" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="pass2" name="confirm_password" required>
                    <div id="matchError" class="error-text">Passwords do not match!</div>
                </div>
            </div>
            <button type="submit" class="reg-btn">Send OTP</button>

            {% else %}
            <!-- OTP Verification -->
            <input type="text" name="otp_code" maxlength="6" required style="text-align:center; font-size:1.5rem; letter-spacing:5px; width:100%; margin-bottom:10px;">
            <div class="timer">
                <span id="timerText">Resend OTP in 60s</span>
                <button type="button" id="resendBtn" disabled>Resend OTP</button>
            </div>
            <button type="submit" class="reg-btn">Submit OTP</button>
            {% endif %}

            <div class="footer-link">
                Already have an account? <a href="{% url 'login' %}">Login here</a>
            </div>
        </form>
    </div>
</div>

<script>
// --- Password Match ---
const form = document.getElementById('regForm');
const p1 = document.getElementById('pass1');
const p2 = document.getElementById('pass2');
const matchError = document.getElementById('matchError');

if (form) {
    form.addEventListener('submit', function(e) {
        if (p1 && p2 && p1.value !== p2.value) {
            e.preventDefault();
            matchError.style.display = 'block';
            p2.style.borderColor = '#dc3545';
        } else if (matchError) {
            matchError.style.display = 'none';
        }
    });
}

// --- Phone Validation ---
function validatePhone(inputElem, errorElem, successElem) {
    const regex = /^(?:\+8801[3-9][0-9]{8}|01[3-9][0-9]{8})$/;
    if (regex.test(inputElem.value)) {
        inputElem.style.borderColor = '#28a745';
        errorElem.style.display = 'none';
        successElem.style.display = 'block';
    } else {
        inputElem.style.borderColor = '#dc3545';
        errorElem.innerText = "Invalid BD phone number!";
        errorElem.style.display = 'block';
        successElem.style.display = 'none';
    }
}

const phoneInput = document.getElementById('phoneInput');
const phoneError = document.getElementById('phoneError');
const phoneSuccess = document.getElementById('phoneSuccess');

if (phoneInput) {
    phoneInput.addEventListener('input', () => validatePhone(phoneInput, phoneError, phoneSuccess));
}

// --- OTP Timer & Resend ---
const timerText = document.getElementById('timerText');
const resendBtn = document.getElementById('resendBtn');

if (timerText && resendBtn) {
    let time = 60;
    const interval = setInterval(() => {
        if (time > 0) {
            timerText.innerText = `Resend OTP in ${time}s`;
            time--;
        } else {
            resendBtn.disabled = false;
            timerText.innerText = "You can resend OTP now";
            clearInterval(interval);
        }
    }, 1000);

    resendBtn.addEventListener('click', () => {
        fetch('/resend-otp/', {
            method: 'POST',
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
        .then(res => res.json())
        .then(data => {
            alert("OTP Resent!");
            resendBtn.disabled = true;
            time = 60;
            const restartInterval = setInterval(() => {
                if (time > 0) {
                    timerText.innerText = `Resend OTP in ${time}s`;
                    time--;
                } else {
                    resendBtn.disabled = false;
                    timerText.innerText = "You can resend OTP now";
                    clearInterval(restartInterval);
                }
            }, 1000);
        });
    });
}

// --- Change Phone with "Change Number" button ---
const changePhoneBtn = document.getElementById('changePhoneBtn');
if (changePhoneBtn) {
    const phoneDisplay = document.getElementById('phoneDisplay');
    const parent = phoneDisplay.parentNode;

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'phone';
    input.id = 'phoneInput';
    input.placeholder = 'e.g. 01700000000 or +8801700000000';
    input.style.marginTop = '10px';
    input.style.padding = '10px';
    input.style.width = '100%';
    input.style.borderRadius = '6px';
    input.style.border = '1px solid #ddd';
    input.style.fontSize = '0.95rem';
    input.style.display = 'none';

    const errorDiv = document.createElement('div');
    errorDiv.id = 'phoneError';
    errorDiv.className = 'error-text';

    const successDiv = document.createElement('div');
    successDiv.id = 'phoneSuccess';
    successDiv.className = 'success-text';
    successDiv.innerText = 'Valid phone';

    const updateBtn = document.createElement('button');
    updateBtn.type = 'button';
    updateBtn.className = 'change-number-btn';
    updateBtn.innerText = 'Update Number';
    updateBtn.style.display = 'none';

    parent.appendChild(input);
    parent.appendChild(errorDiv);
    parent.appendChild(successDiv);
    parent.appendChild(updateBtn);

    function validatePhoneField() {
        const regex = /^(?:\+8801[3-9][0-9]{8}|01[3-9][0-9]{8})$/;
        if (regex.test(input.value)) {
            input.style.borderColor = '#28a745';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'block';
            return true;
        } else {
            input.style.borderColor = '#dc3545';
            errorDiv.innerText = 'Invalid BD phone number!';
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
            return false;
        }
    }

    input.addEventListener('input', validatePhoneField);

    changePhoneBtn.addEventListener('click', () => {
        input.value = phoneDisplay.innerText;
        input.style.display = 'inline';
        phoneDisplay.style.display = 'none';
        updateBtn.style.display = 'inline';

        const otpInput = document.querySelector('input[name="otp_code"]');
        const otpTimerDiv = document.querySelector('.timer');
        const submitOtpBtn = document.querySelector('.reg-btn');

        if (otpInput) otpInput.style.display = 'none';
        if (otpTimerDiv) otpTimerDiv.style.display = 'none';
        if (submitOtpBtn) submitOtpBtn.style.display = 'none';
    });

    updateBtn.addEventListener('click', () => {
        if (!validatePhoneField()) {
            alert('Enter a valid Bangladeshi phone number!');
            return;
        }

        phoneDisplay.innerText = input.value;
        input.style.display = 'none';
        phoneDisplay.style.display = 'inline';
        updateBtn.style.display = 'none';

        const otpInput = document.querySelector('input[name="otp_code"]');
        const otpTimerDiv = document.querySelector('.timer');
        const submitOtpBtn = document.querySelector('.reg-btn');

        if (otpInput) otpInput.style.display = 'inline';
        if (otpTimerDiv) otpTimerDiv.style.display = 'inline';
        if (submitOtpBtn) submitOtpBtn.style.display = 'inline';

        alert('Phone number updated. Please click "Send OTP" to receive a new OTP.');
    });
}

// --- Aggregator Toggle JS ---
const aggregatorToggle = document.getElementById('aggregatorToggle');
const brtcInput = document.getElementById('brtcLicenceInput');

if (aggregatorToggle && brtcInput) {
    aggregatorToggle.addEventListener('change', () => {
        if (aggregatorToggle.checked) {
            brtcInput.removeAttribute('disabled');
        } else {
            brtcInput.value = '';
            brtcInput.setAttribute('disabled', 'true');
        }
    });
    // Initialize as disabled
    brtcInput.setAttribute('disabled', 'true');
}

// --- Live Email Uniqueness Check ---
const emailInput = document.getElementById('emailInput');
const emailError = document.getElementById('emailError');
const emailSuccess = document.getElementById('emailSuccess');

if (emailInput) {
    emailInput.addEventListener('input', () => {
        const email = emailInput.value.trim();
        if (!email) return;

        fetch(`/check_email/?email=${encodeURIComponent(email)}`)
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    emailInput.style.borderColor = '#dc3545';
                    emailError.innerText = 'Email already exists!';
                    emailError.style.display = 'block';
                    emailSuccess.style.display = 'none';
                } else {
                    emailInput.style.borderColor = '#28a745';
                    emailError.style.display = 'none';
                    emailSuccess.style.display = 'block';
                }
            });
    });
}

// --- Live Phone Uniqueness Check ---
if (phoneInput) {
    phoneInput.addEventListener('input', () => {
        const phone = phoneInput.value.trim();
        if (!phone) return;

        fetch(`/check_phone/?phone=${encodeURIComponent(phone)}`)
            .then(res => res.json())
            .then(data => {
                if (data.phone_exists) {
                    phoneInput.style.borderColor = '#dc3545';
                    phoneError.innerText = 'Phone number already exists!';
                    phoneError.style.display = 'block';
                    phoneSuccess.style.display = 'none';
                } else {
                    phoneInput.style.borderColor = '#28a745';
                    phoneError.style.display = 'none';
                    phoneSuccess.style.display = 'block';
                }
            });
    });
}

</script>
{% endblock main %}